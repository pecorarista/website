<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@pecorarista">
    <meta name="twitter:title" content="位置エンコーディング — pecorarista.com">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://pecorarista.com/static/images/avatar.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Judson&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cosmo/bootstrap.min.css" integrity="sha384-5QFXyVb+lrCzdN228VS3HmzpiE7ZVwLQtkt+0d9W43LQMzz4HBnnqvVxKg6O+04d" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-lucario.min.css" integrity="sha512-Aj5jCt/M5XlTn+Y93TazO+EjpRTiUGMrMuaJOcBcu80Fopd7+LSL094m3pbVTNJxf1hOAMSYI/hONBGjvPWwGQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/static/css/main.css"/>

    <title>位置エンコーディング</title>
  </head>
  <body>
    <div class="wrapper">
      <header>
        <nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <div class="navbar-header pull-left"><a class="navbar-brand" href="/">pecorarista.com</a></div>
    <div class="navbar-header pull-right">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link active" href="/resources">Resources</a></li>
      </ul>
    </div>
  </div>
</nav>

      </header>
      <main>
        
<article>
  <div class="container">
    <h1>位置エンコーディング</h1>
    <div class="info text-muted">
      Posted: 2023-03-10
      
    </div>
    
<section>
<p>
<strong>定義</strong>
\(D\)
を
正の偶数とする．
\(\mathbb{R}^D\)
への位置エンコーディング
\(f\)
は，
\(\mathbb{N} = \{0,\,1,\,\ldots\}\)
から
\(\mathbb{R}^D\)
への写像で，
像
\(f(t)\)
の第
\(i\)
成分
\({f(t)}_i\)
が
\begin{align*}
{f(t)}_i =
  \begin{cases}
    \sin (\omega_{\varphi(i)}\, t) &amp; \text{if \(i \equiv 1 \bmod 2\)}, \\
    \cos (\omega_{\varphi(i)}\, t) &amp; \text{otherwise}, \\
  \end{cases}
\end{align*}
ただし，
\begin{align*}
  \varphi(i) = 2 \left\lfloor \frac{i - 1}{2} \right\rfloor,\quad
  \omega_k
  =
  \frac{1}{10000^{
      \frac{k}{D}
    }
  }
\end{align*}
のように定める．
</p>
<p>
<strong>例</strong>
\begin{align*}
  \varphi(1) = 0,\,\varphi(2) = 0,\,\varphi(3) = 2,\,\varphi(4) = 2,\,\varphi(5) = 4,\,\varphi(6) = 4,\,\ldots
\end{align*}
</p>
<p>
<strong>例</strong>
\(D = 128\)
のとき
\begin{gather*}
  f(0) =
  \begin{pmatrix}
    \sin (0) \\
    \cos (0) \\
    \vdots \\
    \sin (0) \\
    \cos (0)
  \end{pmatrix}
  =
  \begin{pmatrix}
    0 \\
    1 \\
    \vdots \\
    0 \\
    1
  \end{pmatrix}
  ,\\[4pt]
  f(1) =
  \begin{pmatrix}
    \sin (\omega_{\varphi(1)}) \\
    \cos (\omega_{\varphi(2)}) \\
    \vdots \\
    \sin (\omega_{\varphi(127)}) \\
    \cos (\omega_{\varphi(128)})
  \end{pmatrix}
  =
  \begin{pmatrix}
    \sin {\frac{1}{10000^{0/128}}} \\
    \cos {\frac{1}{10000^{0/128}}} \\
    \vdots \\
    \sin {\frac{1}{10000^{126/128}}} \\
    \cos {\frac{1}{10000^{126/128}}} \\
  \end{pmatrix}
  \approx
    \begin{pmatrix}
      0.8414 \\
      0.5403 \\
      \vdots \\
      0.0001 \\
      0.9999
    \end{pmatrix}
    ,\\[4pt]
  f(2) =
  \begin{pmatrix}
    \sin (\omega_{\varphi(1)} \cdot 2) \\
    \cos (\omega_{\varphi(2)} \cdot 2) \\
    \vdots \\
    \sin (\omega_{\varphi(127)} \cdot 2) \\
    \cos (\omega_{\varphi(128)} \cdot 2)
  \end{pmatrix}
  =
  \begin{pmatrix}
    \sin {\frac{2}{10000^{0/128}}} \\
    \cos {\frac{2}{10000^{0/128}}} \\
    \vdots \\
    \sin {\frac{2}{10000^{126/128}}} \\
    \cos {\frac{2}{10000^{126/128}}} \\
  \end{pmatrix}
  \approx
    \begin{pmatrix}
      0.9092 \\
      -0.4161 \\
      \vdots \\
      0.0002 \\
      0.9999
    \end{pmatrix}
\end{gather*}
となる．
</p>
<p>
下の
<strong>図 1</strong>
と
<strong>図 2</strong>
を見ると分かるように，
\(\sin (\omega\, t) \)
は
\(\omega\)
が小さくなるほど，周期が大きくなる。
すなわち成分を縦に並べたときに下の方ほどゆっくり変化する。
<figure class="centered">
<figcaption><strong>図 1：</strong>\(y = \sin x\)
のグラフ。</figcaption>
  <img
    src="/static/images/sinx.svg"
    alt=""
    style="background-color: transparent; width: 100%; height: auto; max-width: 1200px; margin-top: 2ex;"
  />
</figure>
<figure class="centered">
<figcaption><strong>図 2：</strong>\(\displaystyle y = \sin \frac{1}{2}x\)
のグラフ。</figcaption>
  <img
    src="/static/images/sin0.5x.svg"
    alt=""
    style="background-color: transparent; width: 100%; height: auto; max-width: 1200px; margin-top: 2ex;"
  />
</figure>
ヒートマップを使って可視化すると
<strong>図 3</strong>
のようになる．
<figure class="centered">
  <figcaption><strong>図 3：</strong>\(D = 128,\,t = 0,\,\ldots,\,50\)
のヒートマップ。</figcaption>
  <img
    src="/static/images/heatmap.svg"
    alt=""
    style="background-color: transparent; width: 100%; height: auto; max-width: 800px; margin-top: 2ex;"
  />
</figure>
位置の加法は、線型変換とみなせる。
\begin{align*}
  f(t + t')
  &amp;=
  \begin{pmatrix}
    \sin (\omega_{\varphi(1)}\, (t + t')) \\
    \cos (\omega_{\varphi(2)}\, (t + t')) \\
    \vdots \\
    \sin (\omega_{\varphi(D - 1)}\, (t + t')) \\
    \cos (\omega_{\varphi(D)}\, (t + t'))
  \end{pmatrix} \\[4pt]
  &amp;=
  \begin{pmatrix}
    \sin (\omega_0 \, t + \omega_0 \, t') \\
    \cos (\omega_0 \, t + \omega_0 \, t') \\
    \vdots \\
    \sin (\omega_{D/2}\, t + \omega_{D/2}\, t') \\
    \cos (\omega_{D/2}\, t + \omega_{D/2}\, t')
  \end{pmatrix} \\[4pt]
  &amp;=
  \begin{pmatrix}
    \sin (\omega_0\, t) \cos (\omega_0\, t') + \cos (\omega_0\, t) \sin (\omega_0\, t') \\
    \cos (\omega_0\, t) \cos (\omega_0\, t') - \sin (\omega_0\, t) \sin (\omega_0\, t') \\
    \vdots \\
    \sin (\omega_{D/2}\, t) \cos (\omega_{D/2}\, t') + \cos (\omega_{D/2}\, t) \sin (\omega_{D/2}\, t') \\
    \cos (\omega_{D/2}\, t) \cos (\omega_{D/2}\, t') - \sin (\omega_{D/2}\, t) \sin (\omega_{D/2}\, t') \\
  \end{pmatrix} \\[4pt]
  &amp;=
  \begin{pmatrix}
\cos(\omega_0\,t')  &amp; \sin(\omega_0\,t') &amp; \cdots &amp; 0                      &amp; 0                      \\
-\sin(\omega_0\,t') &amp; \cos(\omega_0\,t') &amp; \cdots &amp; 0                      &amp; 0                      \\
           \vdots   &amp;          \vdots    &amp; \ddots &amp; \vdots                 &amp; \vdots                 \\
           0        &amp;               0    &amp; \cdots &amp; \cos(\omega_{D/2}\,t') &amp; \sin(\omega_{D/2}\,t') \\
           0        &amp;               0    &amp; \cdots &amp; -\sin(_{D/2}\,t')      &amp; \cos(\omega_{D/2}\,t') \\
  \end{pmatrix}
  \begin{pmatrix}
    \sin (\omega_0\, t) \\
    \cos (\omega_0\, t) \\
    \vdots \\
    \sin (\omega_{D/2}\, t) \\
    \cos (\omega_{D/2}\, t)
  \end{pmatrix} \\[4pt]
  &amp;=
  R(t') f(t)
\end{align*}
<pre><code class="language-python">import numpy
import seaborn
from matplotlib import pyplot
import itertools


def main() -&gt; None:
    D = 128
    T = 51
    data = numpy.zeros((T, D), dtype=float)
    for (t, d) in itertools.product(range(T), range(D)):
        f = numpy.sin if d % 2 == 0 else numpy.cos
        omega = 1 / (10_000 ** (2 * numpy.floor(d / 2) / D))
        data[t, d] = f(omega * t)
    h = seaborn.heatmap(data.T, vmin=-1.0, cbar_kws={&#39;ticks&#39;: [-1.0, -0.5, 0.0, 0.5, 1.0]})
    h.set_xlabel(&#39;t (position)&#39;)
    h.set_ylabel(&#39;i (dimension)&#39;)
    xticklabels = [t for t in range(T) if t % 10 == 0]
    h.set_xticks([x + 0.5 for x in xticklabels])
    h.set_xticklabels(xticklabels)
    yticklabels = [1] + [y for y in range(D + 1) if y % 16 == 0 and y &gt; 0]
    h.set_yticks([y - 0.5 for y in yticklabels])
    h.set_yticklabels(yticklabels)
    pyplot.savefig(&#39;../images/heatmap.svg&#39;, bbox_inches=&#39;tight&#39;, transparent=True)
    pyplot.show()


if __name__ == &#39;__main__&#39;:
    main()
</code></pre>
</p>
</section>
<section id="materials">
  <h2>参考文献</h2>
  <ul>
  <li id="Jonathan-kernes"><a href="https://towardsdatascience.com/master-positional-encoding-part-i-63c05d90a0c3">Towards Data Science | <em>Master Positional Encoding: Part I</em></a></li>
  <li id="kikaben"><a href="https://kikaben.com/transformers-positional-encoding/">KiKaBeN | <em>Transformer’s Positional Encoding: How Does It Know Word Positions Without Recurrence?</em></a></li>
    <li id="amirhossein-kazemnejad"><a href="https://kazemnejad.com/blog/transformer_architecture_positional_encoding/">Amirhossein Kazemnejad's Blog | <em>Transformer Architecture: The Positional Encoding—Let's use sinusoidal functions to inject the order of words in our model</em></a></li>
  </ul>
</section>

  </div>
</article>

      </main>
      <footer>
        <div class="footer text-center">
  <span>© 2015&ndash;2023 Akira Miyazawa</span>
</div>

      </footer>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap.native@2.0.15/dist/bootstrap-native-v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-SkmBfuA2hqjzEVpmnMt/LINrjop3GKWqsuLSSB3e7iBmYK7JuWw4ldmmxwD9mdm2IRTTi0OxSAfEGvgEi0i2Kw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://kit.fontawesome.com/30a99ec99f.js" crossorigin="anonymous"></script>
<script src="/static/js/main.js"></script>

      
        <script src="/static/js/mathjax.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?config=TeX-AMS_HTML"></script>
        </script>
      
    </div>
  </body>
</html>
