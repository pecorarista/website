<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@pecorarista">
  <meta name="twitter:title" content="Cross entropyやsoftmaxに関するメモ — pecorarista.com">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="https://pecorarista.com/static/images/avatar.png">
  <link rel="icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&family=Noto+Serif+JP&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Amiri&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Judson&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cosmo/bootstrap.min.css" integrity="sha384-5QFXyVb+lrCzdN228VS3HmzpiE7ZVwLQtkt+0d9W43LQMzz4HBnnqvVxKg6O+04d" crossorigin="anonymous">
  <link rel="stylesheet" href="/static/css/prism-lucario.css" />
  <link rel="stylesheet" href="/static/css/main.css" />

  <title>Cross entropyやsoftmaxに関するメモ</title>
</head>

<body>
  <div class="wrapper">
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
          <div class="navbar-header pull-left"><a class="navbar-brand" href="/">pecorarista.com</a></div>
          <div class="navbar-header pull-right">
            <ul class="navbar-nav">
              <li class="nav-item"><a class="nav-link active" href="/resources">Resources</a></li>
            </ul>
          </div>
        </div>
      </nav>

    </header>
    <main>

      <article>
        <div class="container">
          <h1>Cross entropyやsoftmaxに関するメモ</h1>
          <div class="info text-muted">
            Posted: 2020-03-05

          </div>

          <section>
            <h2>背景にある発想</h2>
            <p>\(K\)-面サイコロについて、出目が
              \(k\)
              となる確率を
              \(q_k\)
              とする。このとき各
              \(q_k\)
              について
              \(0 \leq p \leq 1\)
              かつ
              \(\sum_{k = 1}^K q_k =1\)
              である。したがって
              \(\boldsymbol{q} = (q_1,\,\ldots,\,q_K)^\top\)
              は
              \((K-1)\)-標準単体(standard simplex)
              \(\varDelta^{K -1} = \{ \boldsymbol{x} \in \mathbb{R}^K \mid \sum_{i = 1}^K x_i = 1,\, x_1 \geq 0,\, \ldots,\, x_K \geq 0 \}\)
              に含まれる。この
              \(\boldsymbol{q}\)
              がサイコロのモデルになる。</p>
            <p>全部で
              \(N\)
              回このサイコロを振る。出目が
              \(k\)
              となった回数を
              \(n_k\)
              とし、
              \(p_k := n_k / N\)
              とする。このとき
              \(\boldsymbol{p} = (p_1,\,\ldots,\,p_K)^\top\)
              は観測によって得られた確率である。最尤推定により
              \(\boldsymbol{q}\)
              を求めるには以下を求める。
              \begin{align*}
              \operatorname*{arg\,max}_{\boldsymbol{q} \in \varDelta^{K - 1}} \prod_{k = 1}^K q_k^{Np_k}
              \end{align*}
              負の対数尤度を使って以下の問題を解いても同じである。
              \begin{align*}
              \operatorname*{arg\,min}_{\boldsymbol{q} \in \varDelta^{K - 1}} -\sum_{k = 1}^K p_k \log q_k
              \end{align*}
              この目的関数を\(\boldsymbol{p}\)と\(\boldsymbol{q}\)の<strong>クロスエントロピー</strong>(cross entropy)と呼ぶ。
              \begin{align*}
              \operatorname*{CrossEntropy}(\boldsymbol{p}, \boldsymbol{q}) = - \sum_{k = 1}^K p_k \log q_k
              \end{align*}
            </p>
            <p>\(\varDelta^{K - 1}\)
              の要素とは限らない尤度を表すスコア
              \(\boldsymbol{a} \in \mathbb{R}^K\)
              が与えられた場合、<strong>ソフトマックス</strong>(softmax)を用いて正規化するのが一般的である。
              \begin{align*}
              \operatorname{softmax}(\boldsymbol{a}) =
              \left(
              \frac{\exp(a_1)}{\sum_{k = 1}^K \exp(u_k)},
              \ldots,\,
              \frac{\exp(a_K)}{\sum_{k = 1}^K \exp(a_k)}
              \right)^\top
              \end{align*}
              ソフトマックスの値域は\(\operatorname{relint} \varDelta^{K - 1} = \{ \boldsymbol{x} \in \mathbb{R}^K \mid \sum_{i = 1}^K x_i = 1,\, x_1 \gt 0,\, \ldots,\, x_K \gt 0 \} \subset \varDelta^{K - 1}\)であるので、その出力を確率と見なすことができるのである。
            </p>
          </section>
          <section>
            <h2>誤差逆伝播</h2>
            <p>\(\boldsymbol{q} = \operatorname{softmax}(\boldsymbol{a})\)が成り立つとき、
              \begin{align*}
              \frac{\partial q_k}{\partial a_i}
              &amp;=
              \frac{
              \left(
              \frac{
              \partial
              }{
              \partial a_i
              }
              \exp(a_k)
              \right)
              \sum_{j = 1}^K \exp(a_j)
              -
              \exp(a_k)
              \frac{
              \partial
              }{
              \partial a_i
              }
              \sum_{j = 1}^K \exp(a_j)
              }
              {
              (\sum_{j = 1}^K \exp (a_j))^2
              } \\
              &amp; =
              \frac{
              \delta_{ik}
              \exp(a_k)
              \sum_{j = 1}^K \exp(a_j)
              -
              \exp(a_k)
              \exp(a_i)
              }
              {
              (\sum_{j = 1}^K \exp (a_j))^2
              } \\
              &amp; =
              \delta_{ki} \frac{\exp(a_k)}{\sum_{j = 1}^K \exp(a_j)}
              - \frac{\exp(a_k) \exp(a_i)}{(\sum_{j = 1}^K \exp(a_j))^2} \\
              &amp; =
              q_k( \delta_{ki} - q_i) \\
              \end{align*}
            </p>
            <p>クロスエントロピー
              \(H := \operatorname{CrossEntropy}(\boldsymbol{p}, \boldsymbol{q})\)
              の
              \(a_k\)
              に関する偏導関数は以下のように計算できる。
              \begin{align*}
              \frac{\partial H}{\partial a_i}
              &amp; = - \sum_{k = 1}^K p_k \frac{\partial \log q_k}{\partial q_k} \frac{\partial q_k}{\partial a_i} \\
              &amp; = - p_i \frac{q_i(1 - q_i)}{q_i} - \sum_{k \in \{1,\,\ldots,\,K\} \backslash \{i\}} p_k \frac{- q_k q_i}{q_k}\\
              &amp; = - p_i (1 - q_i) + q_i \sum_{k = 1}^K p_k - p_i q_i \\
              &amp; = - p_i (1 - q_i) + q_i (1 - p_i ) \\
              &amp; = q_i - p_i
              \end{align*}
            </p>
          </section>

        </div>
      </article>

    </main>
    <footer>
      <div class="footer text-center">
        <span>© 2015&ndash;2022 Akira Miyazawa</span>
      </div>

    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap.native@2.0.15/dist/bootstrap-native-v4.min.js"></script>
    <script src="/static/js/prism.js"></script>
    <script src="/static/js/prism-bash.min.js"></script>
    <script src="/static/js/prism-latex.min.js"></script>
    <script src="/static/js/prism-makefile.min.js"></script>
    <script src="/static/js/prism-java.min.js"></script>
    <script src="/static/js/prism-javascript.min.js"></script>
    <script src="/static/js/prism-scala.min.js"></script>
    <script src="/static/js/prism-markdown.min.js"></script>
    <script src="/static/js/prism-apacheconf.min.js"></script>
    <script src="/static/js/prism-perl.min.js"></script>
    <script src="/static/js/prism-haskell.min.js"></script>
    <script src="/static/js/prism-lua.min.js"></script>
    <script src="https://kit.fontawesome.com/30a99ec99f.js" crossorigin="anonymous"></script>
    <script src="/static/js/main.js"></script>


    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <script>
      MathJax = {
        loader: {
          load: [
            '[tex]/cases',
            '[tex]/empheq'
          ]
        },
        tex: {
          packages: {
            '[+]': [
              'empheq',
              'cases'
            ]
          },
          autoload: {
            cases: [
              [],
              ['numcases', 'subnumcases']
            ]
          },
          macros: {
            parentheses: ["\\left(#1\\right)", 1],
            brackets: ["\\left[#1\\right]", 1],
            norm: ["\\left\\|#1\\right\\|", 1],
            abs: ["\\left|#1\\right|", 1],
            diag: "\\mathop{\\rm diag}",
            res: "\\mathop{\\rm Res}",
            real: "\\mathop{\\rm Re}",
            relu: "\\mathop{\\rm ReLU}",
            id: "\\mathop{\\rm id}",
            imaginary: "\\mathop{\\rm Im}"
          },
          tags: 'ams',
        }
      };
    </script>

  </div>
</body>

</html>