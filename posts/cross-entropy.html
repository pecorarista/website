<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@pecorarista">
    <meta name="twitter:title" content="Cross entropyやsoftmaxに関するメモ — pecorarista.com">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://pecorarista.com/static/images/avatar.png">
    <link rel="icon" href="/favicon.ico">
		<script>
			(function(d) {
				var config = {
					kitId: 'mbi1yhb',
					scriptTimeout: 3000,
					async: true
				},
				h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
			})(document);
		</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri&family=Noto+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Noto+Serif:ital@0;1&family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cosmo/bootstrap.min.css" integrity="sha384-5QFXyVb+lrCzdN228VS3HmzpiE7ZVwLQtkt+0d9W43LQMzz4HBnnqvVxKg6O+04d" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-lucario.min.css" integrity="sha512-Aj5jCt/M5XlTn+Y93TazO+EjpRTiUGMrMuaJOcBcu80Fopd7+LSL094m3pbVTNJxf1hOAMSYI/hONBGjvPWwGQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/static/css/main.css"/>

    <title>Cross entropyやsoftmaxに関するメモ</title>
  </head>
  <body>
    <div class="wrapper">
      <header>
        <nav class="navbar navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/">pecorarista.com</a>

    <div class="navbar-nav ms-auto d-flex flex-md-row flex-column align-items-md-center">
      <a class="nav-link active" href="/fictional-works">Fictional Works</a>
      <span class="separator d-none d-md-inline">&#10022;</span>
      <a class="nav-link active" href="/technical-notes">Technical Notes</a>
    </div>
  </div>
</nav>

      </header>
      <main>
        
<article>
  <div class="container">
    <h1>Cross entropyやsoftmaxに関するメモ</h1>
    <div class="info text-muted">
      Posted: 2020-03-05
      
        (Updated: 2022-10-07)
      
    </div>
    
<section>
<h2>背景にある発想</h2>
<p><span class="head">\(K\)</span>-面サイコロについて、出目が\(
  k
\)となる確率を\(
  q_k
\)
とする。このとき各\(
  q_k
\)
について\(
  0 \leq p \leq 1
\)かつ\(
  \sum_{k = 1}^K q_k =1
\)
である。したがって\(
  \boldsymbol{q} = {\begin{pmatrix} q_1 &amp; \cdots &amp; q_K\end{pmatrix}}^\top
\)は<span class="before-hypen">\((K - 1)\)</span>-標準単体<span lang="en">(standard simplex) \(
  \varDelta^{K -1} =
  \{
    \boldsymbol{x} \in \mathbb{R}^K \mid \sum_{i = 1}^K x_i = 1,\, x_1 \geq 0,\, \ldots,\, x_K \geq 0
  \}
\)</span>に含まれる。この\(
  \boldsymbol{q}
\)がサイコロのモデルになる。</p>
<p>全部で\(
  N
\)回このサイコロを振る。出目が\(
  k
\)となった回数を\(
  n_k
\)
とし、\(
  p_k := n_k / N
\)とする。このとき\(
  \boldsymbol{p} = {\begin{pmatrix}p_1 &amp; \cdots &amp; p_K\end{pmatrix}}^\top
\)は観測によって得られた確率である。最尤推定により\(
  \boldsymbol{q}
\)を求めるには以下を求める。
\begin{align*}
  \operatorname*{arg\,max}_{\boldsymbol{q} \in \varDelta^{K - 1}} \prod_{k = 1}^K q_k^{Np_k}
\end{align*}
負の対数尤度を使って以下の問題を解いても同じである。
\begin{align*}
  \operatorname*{arg\,min}_{\boldsymbol{q} \in \varDelta^{K - 1}} -\sum_{k = 1}^K p_k \log q_k
\end{align*}
この目的関数を\(\boldsymbol{p}\)と\(\boldsymbol{q}\)の<strong>クロスエントロピー</strong>(cross entropy)と呼ぶ。
\begin{align*}
  \operatorname*{CrossEntropy}(\boldsymbol{p}, \boldsymbol{q}) = - \sum_{k = 1}^K p_k \log q_k
\end{align*}
</p>
<p><span class="head">\(\varDelta^{K - 1}\)</span>の要素とは限らない尤度を表すスコア\(
  \boldsymbol{a} \in \mathbb{R}^K
\)
が与えられた場合、<strong>ソフトマックス</strong>(softmax)を用いて正規化するのが一般的である。
\begin{align*}
  \softmax(\boldsymbol{a}) =
    \frac{1}{\sum_{k = 1}^K \exp(a_k)}
    \begin{pmatrix}
      \exp(a_1) \\
      \vdots \\
      \exp(a_K)
    \end{pmatrix}
\end{align*}
ソフトマックスの値域は\(
  \operatorname{relint} \varDelta^{K - 1} = \{
    \boldsymbol{x} \in \mathbb{R}^K \mid \sum_{i = 1}^K x_i = 1,\, x_1 \gt 0,\, \ldots,\, x_K \gt 0
  \}
  \subset \varDelta^{K - 1}
\)であるので、その出力を確率と見なすことができるのである。
</p>
</section>
<section>
<h2>誤差逆伝播</h2>
<p><span class="head">\(\boldsymbol{q} = \operatorname{softmax}(\boldsymbol{a})\)</span>が成り立つとき、
\begin{align*}
  \frac{\partial q_k}{\partial a_i}
  &amp;=
  \frac{
    \left(
      \frac{
        \partial
      }{
        \partial a_i
      }
      \exp(a_k)
    \right)
    \sum_{j = 1}^K \exp(a_j)
    -
    \exp(a_k)
    \frac{
      \partial
    }{
      \partial a_i
    }
    \sum_{j = 1}^K \exp(a_j)
  }
  {
    (\sum_{j = 1}^K \exp (a_j))^2
  } \\
 &amp; =
  \frac{
    \delta_{ik}
    \exp(a_k)
    \sum_{j = 1}^K \exp(a_j)
    -
    \exp(a_k)
    \exp(a_i)
  }
  {
    (\sum_{j = 1}^K \exp (a_j))^2
  } \\
  &amp; =
  \delta_{ki} \frac{\exp(a_k)}{\sum_{j = 1}^K \exp(a_j)}
  - \frac{\exp(a_k) \exp(a_i)}{(\sum_{j = 1}^K \exp(a_j))^2} \\
  &amp; =
  q_k( \delta_{ki} - q_i) \\
\end{align*}
</p>
<p>クロスエントロピー\(
  H := \operatorname{CrossEntropy}(\boldsymbol{p}, \boldsymbol{q})
\)
の\(
  a_k
\)に関する偏導関数は以下のように計算できる。
\begin{align*}
    \frac{\partial H}{\partial a_i}
    &amp; = - \sum_{k = 1}^K p_k \frac{\partial \log q_k}{\partial q_k} \frac{\partial q_k}{\partial a_i} \\
    &amp; = - p_i \frac{q_i(1 - q_i)}{q_i} - \sum_{k \in \{1,\,\ldots,\,K\} \backslash \{i\}} p_k \frac{- q_k q_i}{q_k}\\
    &amp; = - p_i (1 - q_i) + q_i \sum_{k = 1}^K p_k - p_i q_i \\
    &amp; = - p_i (1 - q_i) + q_i (1 - p_i ) \\
    &amp; = q_i - p_i
\end{align*}
</p>
</section>

  </div>
</article>

      </main>
      <footer>
        <div class="footer text-center">
  <span>© 2015&ndash;2025 Akira Miyazawa</span>
</div>

      </footer>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap.native@latest/dist/bootstrap-native.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-SkmBfuA2hqjzEVpmnMt/LINrjop3GKWqsuLSSB3e7iBmYK7JuWw4ldmmxwD9mdm2IRTTi0OxSAfEGvgEi0i2Kw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://kit.fontawesome.com/30a99ec99f.js" crossorigin="anonymous"></script>
<script src="/static/js/main.js"></script>

      
        <script src="/static/js/mathjax.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?config=TeX-AMS_HTML"></script>
        </script>
      
    </div>
  </body>
</html>
