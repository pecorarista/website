{% extends 'nunjucks/_layout/_article.njk' %}
{% set lang = 'ja' %}
{% set mathematical = 'true' %}
{% set title = '位置エンコーディング' %}
{% set posted = '2023-03-10' %}

{% block post %}
<section>
<p>
<strong>定義</strong>
\(D\)
を
正の偶数とする．
\(\mathbb{R}^D\)
への位置エンコーディング
\(f\)
は，
\(\mathbb{N} = \{0,\,1,\,\ldots\}\)
から
\(\mathbb{R}^D\)
への写像で，
像
\(f(t)\)
の第
\(i\)
成分
\({f(t)}_i\)
が
\begin{align*}
{f(t)}_i =
  \begin{cases}
    \sin (\omega_{\varphi(i)}\, t) &amp; \text{if \(i \equiv 1 \bmod 2\)}, \\
    \cos (\omega_{\varphi(i)}\, t) &amp; \text{otherwise}, \\
  \end{cases}
\end{align*}
ただし，
\begin{align*}
  \varphi(i) = 2 \left\lfloor \frac{i - 1}{2} \right\rfloor,\quad
  \omega_k
  =
  \frac{1}{10000^{
      \frac{k}{D}
    }
  }
\end{align*}
のように定める．
</p>
<p>
<strong>例</strong>
\begin{align*}
  \varphi(1) = 0,\,\varphi(2) = 0,\,\varphi(3) = 2,\,\varphi(4) = 2,\,\varphi(5) = 4,\,\varphi(6) = 4,\,\ldots
\end{align*}
</p>
<p>
<strong>例</strong>
\(D = 128\)
のとき
\begin{gather*}
  f(0) =
  \begin{pmatrix}
    \sin (0) \\
    \cos (0) \\
    \vdots \\
    \sin (0) \\
    \cos (0)
  \end{pmatrix}
  =
  \begin{pmatrix}
    0 \\
    1 \\
    \vdots \\
    0 \\
    1
  \end{pmatrix}
  ,\\[4pt]
  f(1) =
  \begin{pmatrix}
    \sin (\omega_{\varphi(1)}) \\
    \cos (\omega_{\varphi(2)}) \\
    \vdots \\
    \sin (\omega_{\varphi(127)}) \\
    \cos (\omega_{\varphi(128)})
  \end{pmatrix}
  =
  \begin{pmatrix}
    \sin {\frac{1}{10000^{0/128}}} \\
    \cos {\frac{1}{10000^{0/128}}} \\
    \vdots \\
    \sin {\frac{1}{10000^{126/128}}} \\
    \cos {\frac{1}{10000^{126/128}}} \\
  \end{pmatrix}
  \approx
    \begin{pmatrix}
      0.8414 \\
      0.5403 \\
      \vdots \\
      0.0001 \\
      0.9999
    \end{pmatrix}
    ,\\[4pt]
  f(2) =
  \begin{pmatrix}
    \sin (\omega_{\varphi(1)} \cdot 2) \\
    \cos (\omega_{\varphi(2)} \cdot 2) \\
    \vdots \\
    \sin (\omega_{\varphi(127)} \cdot 2) \\
    \cos (\omega_{\varphi(128)} \cdot 2)
  \end{pmatrix}
  =
  \begin{pmatrix}
    \sin {\frac{2}{10000^{0/128}}} \\
    \cos {\frac{2}{10000^{0/128}}} \\
    \vdots \\
    \sin {\frac{2}{10000^{126/128}}} \\
    \cos {\frac{2}{10000^{126/128}}} \\
  \end{pmatrix}
  \approx
    \begin{pmatrix}
      0.9092 \\
      -0.4161 \\
      \vdots \\
      0.0002 \\
      0.9999
    \end{pmatrix}
\end{gather*}
となる．
</p>
<p>
<h2>なぜ三角関数を使うのか？</h2>
三角関数を用いる理由は，各成分の周期を変えることにより，
位置に固有のベクトルを生成できるからである．
下の
図 1
と
図 2
を見ると分かるように，
\(\sin (\omega\, t) \)
は
\(\omega\)
が小さくなるほど，周期 \((= 2\pi / \omega)\) が大きくなる．
すなわち，成分を縦に並べたとき，下の方にある成分ほどゆっくり変化する．
<figure class="centered">
<figcaption><strong>図 1：</strong>\(y = \sin x\)
のグラフ．周期は \(2\pi\)．</figcaption>
  <img
    src="/static/images/sinx.svg"
    alt=""
    style="background-color: transparent; width: 100%; height: auto; max-width: 1200px; margin-top: 2ex;"
  />
</figure>
<figure class="centered">
<figcaption><strong>図 2：</strong>\(\displaystyle y = \sin \frac{1}{2}x\)
のグラフ．周期は \(\displaystyle \frac{2\pi }{1 / 2} = 4\pi\)．</figcaption>
  <img
    src="/static/images/sin0.5x.svg"
    alt=""
    style="background-color: transparent; width: 100%; height: auto; max-width: 1200px; margin-top: 2ex;"
  />
</figure>
ヒートマップを使って可視化すると
図 3
のようになる．
<figure class="centered">
  <figcaption><strong>図 3：</strong>\(D = 128,\,t = 0,\,\ldots,\,50\)
のヒートマップ．</figcaption>
  <img
    src="/static/images/heatmap.svg"
    alt=""
    style="background-color: transparent; width: 100%; height: auto; max-width: 800px;"
  />
</figure>
<figure>
  <figcaption>ヒートマップの作成に使用した Python スクリプト．</figcaption>
  <pre><code class="language-python">{{ includeFile('python/main.py') }}</code></pre>
</figure>


<h2>なぜ \(\sin\) と \(\cos\) の両方を使うのか？また，なぜ \(\omega\) の添え字が2個ずつ同じになっているのか？</h2>
<p>位置の変位を線型変換に対応させたいから．</p>
<figure class="blockquote">
<blockquote>
<p>We chose this function because we hypothesized it would allow the model to easily learn to attend by
relative positions, since for any fixed offset \(k\), \(PE_{ \mathit{pos} + k}\) can be represented as a linear function of
\(PE_\mathit{pos}\).</p>
</blockquote>
<figcaption class="blockquote-footer">
Vaswani et al. (2017)
</figcaption>
</figure>
<p>
<strong>証明</strong>
\begin{align*}
  f(t + t')
  &amp;=
  \begin{pmatrix}
    \sin (\omega_{\varphi(1)}\, (t + t')) \\
    \cos (\omega_{\varphi(2)}\, (t + t')) \\
    \vdots \\
    \sin (\omega_{\varphi(D - 1)}\, (t + t')) \\
    \cos (\omega_{\varphi(D)}\, (t + t'))
  \end{pmatrix} \\[4pt]
  &amp;=
  \begin{pmatrix}
    \sin (\omega_0 \, t + \omega_0 \, t') \\
    \cos (\omega_0 \, t + \omega_0 \, t') \\
    \vdots \\
    \sin (\omega_{D/2}\, t + \omega_{D/2}\, t') \\
    \cos (\omega_{D/2}\, t + \omega_{D/2}\, t')
  \end{pmatrix} \\[4pt]
  &amp;=
  \begin{pmatrix}
    \sin (\omega_0\, t) \cos (\omega_0\, t') + \cos (\omega_0\, t) \sin (\omega_0\, t') \\
    \cos (\omega_0\, t) \cos (\omega_0\, t') - \sin (\omega_0\, t) \sin (\omega_0\, t') \\
    \vdots \\
    \sin (\omega_{D/2}\, t) \cos (\omega_{D/2}\, t') + \cos (\omega_{D/2}\, t) \sin (\omega_{D/2}\, t') \\
    \cos (\omega_{D/2}\, t) \cos (\omega_{D/2}\, t') - \sin (\omega_{D/2}\, t) \sin (\omega_{D/2}\, t') \\
  \end{pmatrix} \\[4pt]
  &amp;=
  \begin{pmatrix}
\cos(\omega_0\,t')  &amp; \sin(\omega_0\,t') &amp; \cdots &amp; 0                      &amp; 0                      \\
-\sin(\omega_0\,t') &amp; \cos(\omega_0\,t') &amp; \cdots &amp; 0                      &amp; 0                      \\
           \vdots   &amp;          \vdots    &amp; \ddots &amp; \vdots                 &amp; \vdots                 \\
           0        &amp;               0    &amp; \cdots &amp; \cos(\omega_{D/2}\,t') &amp; \sin(\omega_{D/2}\,t') \\
           0        &amp;               0    &amp; \cdots &amp; -\sin(_{D/2}\,t')      &amp; \cos(\omega_{D/2}\,t') \\
  \end{pmatrix}
  \begin{pmatrix}
    \sin (\omega_0\, t) \\
    \cos (\omega_0\, t) \\
    \vdots \\
    \sin (\omega_{D/2}\, t) \\
    \cos (\omega_{D/2}\, t)
  \end{pmatrix} \\[4pt]
  &amp;=
  A(t') f(t).
\end{align*}
ここで
\begin{gather}
  A(t') =
  \begin{pmatrix}
    R_0\,(t) &amp; O        &amp; \cdots &amp; O            \\
    O        &amp; R_2\,(t) &amp; \cdots &amp; O            \\
    \vdots   &amp; \vdots   &amp; \ddots &amp; \vdots       \\
    O        &amp; O        &amp; \cdots &amp; R_{D/2}\,(t) \\
  \end{pmatrix},
  \notag \\[4pt]
  R_k(t') =
  \begin{pmatrix}
    \cos (\omega_k\,t) &amp; \sin (\omega_k\, t) \\
    -\sin (\omega_k\,t) &amp; \cos (\omega_k\, t) \\
    \end{pmatrix}.
  \tag*{&#8718;}
\end{gather}
</p>
<p>\(R_k (t')\) は \(\mathbb{R}^2\) の要素を \(- \omega_k\, t'\) だけ回転させる線型変換である．
この結果を得るために \(\sin\), \(\cos\) の両方を用い，また \(\omega\) の添え字を2個ずつ同じにしているのである．</p>
</section>
<section id="materials">
  <h2>参考文献</h2>
  <ul>
  <li><a href="https://papers.nips.cc/paper/2017/hash/3f5ee243547dee91fbd053c1c4a845aa-Abstract.html">Vaswani et al. (2017). “Attention Is All You Need”. In <em>Advances in Neural Information Processing Systems.</em> Vol. 30.</a></li>
  <li id="amirhossein-kazemnejad"><a href="https://kazemnejad.com/blog/transformer_architecture_positional_encoding/">Amirhossein Kazemnejad's Blog | <em>Transformer Architecture: The Positional Encoding—Let's use sinusoidal functions to inject the order of words in our model</em></a></li>
  <li id="kikaben"><a href="https://kikaben.com/transformers-positional-encoding/">KiKaBeN | <em>Transformer’s Positional Encoding: How Does It Know Word Positions Without Recurrence?</em></a></li>
  <li id="Jonathan-kernes"><a href="https://towardsdatascience.com/master-positional-encoding-part-i-63c05d90a0c3">Towards Data Science | <em>Master Positional Encoding: Part I</em></a></li>
  </ul>
</section>
{% endblock %}
